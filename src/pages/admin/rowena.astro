---
import QrCard from "@/adminComponents/QrCard.astro";
import MainLayout from "@/layouts/MainLayout.astro";
import { db, User } from "astro:db";
import qrcode from 'qrcode';

const { user } = Astro.locals;
if (user == null) {
  return Astro.redirect("/admin/signin");
} else {
  console.log(user);
}

const qrUsers = await db.select().from(User);

// Chequeo adicional para asegurar valores vÃ¡lidos
const usersWithQR = await Promise.all(qrUsers.map(async (oneUser) => {
  if (oneUser.qr && oneUser.qr.trim() !== '') {
    const qrCode = await qrcode.toDataURL(oneUser.qr);
    return { ...oneUser, qrCode };
  } else {
    console.error(`No input text for oneUser ${oneUser.id}`);
    return { ...oneUser, qrCode: null };
  }
}));

---

<MainLayout>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-52 mt-10 mx-10">
    {usersWithQR.map(user => (
      <QrCard user={user} />
    ))}
  </div>
</MainLayout>
